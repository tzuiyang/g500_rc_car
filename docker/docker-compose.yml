version: "3.9"

# G500 RC Car — Full Stack
# Usage:
#   RPi deployment : docker compose up -d
#   Dev (no camera): docker compose up server
#
# Environment variables (override in .env file):
#   SERIAL_PATH  — e.g. /dev/ttyUSB0  (auto-detected if blank)
#   SERIAL_BAUD  — default 115200
#   CAMERA_URL   — default http://camera:8080/stream
#   CAMERA_INDEX — default 0 (/dev/video0, Innomaker U20CAM)

services:

  # ── Node.js backend + UI ────────────────────────────────────────────────────
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      SERIAL_PATH: ${SERIAL_PATH:-}          # leave blank for auto-detect
      SERIAL_BAUD: ${SERIAL_BAUD:-115200}
      CAMERA_URL: http://camera:8080/stream
    # Pass Arduino serial device into container
    devices:
      - "${SERIAL_PATH:-/dev/ttyUSB0}:/dev/ttyUSB0"
    depends_on:
      - camera
    networks:
      - g500

  # ── Python camera service (U20CAM 1080p USB webcam → MJPEG) ─────────────────
  camera:
    build:
      context: ..
      dockerfile: docker/Dockerfile.camera
    restart: unless-stopped
    # Pass webcam V4L2 device into container
    devices:
      - "/dev/video0:/dev/video0"
    environment:
      CAMERA_INDEX: ${CAMERA_INDEX:-0}
    ports:
      - "8080:8080"   # exposed for direct debug; server proxies it internally
    networks:
      - g500

networks:
  g500:
    driver: bridge
